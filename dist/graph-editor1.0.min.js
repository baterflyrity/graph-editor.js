function GraphEditor(t,e,a=["Новый узел"],i,n,s){function l(t,e,a){let i;e=e||window;let n=t.split(".");a=a||n[0],n.forEach(t=>{if(void 0===(i=e[t]))throw`Graph editor error: ${a} library must be included.`;e=i})}l("jQuery"),l("vis.Network",!1,"Vis.js Network"),l("vis.DataSet",!1,"Vis.js DataSet"),l("transition",jQuery(),"Semantic UI"),l("modal",jQuery(),"Semantic UI"),l("dropdown",jQuery(),"Semantic UI");let r={container:jQuery(t).first(),save:()=>(function(t,e,a){let i=document.createElement("a"),n=new Blob([t],{type:a});i.href=URL.createObjectURL(n),i.download=e,i.click()})(r.serialize(),"graph.json","application/json"),addNode:(t,e=0,a,i={})=>{r.graph.storePositions();let n={x:0,y:0},s=r.data[GraphEditor.ElementClasses.node.classID].get();s.length&&(n.x=s.map(t=>t.x).reduce((t, e)=>t+e)/s.length,n.y=s.map(t=>t.y).reduce((t, e)=>t+e)/s.length,n.x+=100*Math.random()-50,n.y+=100*Math.random()-50);let l=$.extend(!0,r.types[GraphEditor.ElementClasses.node.classID][e].template,{id:t,type:e,label:a},n,i);return r.data[GraphEditor.ElementClasses.node.classID].add(l)[0]},addEdge:(t, e, a, i=0, n={})=>{let s=Object.assign({},r.types[GraphEditor.ElementClasses.edge.classID][i].template,{id:a,type:i,from:t,to:e},n);return r.data[GraphEditor.ElementClasses.edge.classID].add(s)[0]},removeNode: t=>r.data[GraphEditor.ElementClasses.node.classID].remove(t),removeEdge: t=>r.data[GraphEditor.ElementClasses.edge.classID].remove(t)};if(r.data={[GraphEditor.ElementClasses.node.classID]:new vis.DataSet(n),[GraphEditor.ElementClasses.edge.classID]:new vis.DataSet(s)},r.types={[GraphEditor.ElementClasses.node.classID]:e||GraphEditor.CreateStyles_old(GraphEditor.CreateType_old("0","Эллипс","Синие эллипсы","blue",{color:"#8dd0f8",shape:"ellipse"}),GraphEditor.CreateType_old("1","Прямоугольник","Зелёные прямоугольники","green",{color:"#82ec93",shape:"box"})),[GraphEditor.ElementClasses.edge.classID]:i||GraphEditor.CreateStyles_old(GraphEditor.CreateType_old("0","Сплошное","Без штриховки","hidden",{arrows:"to",dashes:!1,color:{inherit:"both"}}),GraphEditor.CreateType_old("1","Штрихованное","Равномерная штриховка","hidden",{arrows:"to",dashes:!0,color:{inherit:"both"}}))},!r.container.length)throw"Graph editor error: can not find container.";function d(t, e, i, n){let s,l=r.types[t],d=Object.keys(l).map(t=>`<div class="item" data-value="${t}" data-text='<div class="ui ${l[t].color} empty circular label"></div> ${l[t].name}'><div class="ui ${l[t].color} empty circular label"></div> ${l[t].name} <span class="description">${l[t].description}</span></div>`);if(t===GraphEditor.ElementClasses.edge.classID)s='<div class="label-text" contenteditable="true" data-placeholder="Введите название">Название</div>';else if(r.types[t][e].titles){s=`<div class="ui search selection dropdown"><input type="hidden" value="0" data-property="title"><i class="dropdown icon"></i><div class="label-text text">Название</div><div class="menu">${Object.keys(a).map(t=>`<div class="item" data-value="${t}" data-text='${a[t]}'>${a[t]}</span></div>`).join("")}</div></div>`}else s='<div class="label-text" contenteditable="true" data-placeholder="Введите название">Название</div>';let c=jQuery(`<div class="class-editor"><div class="ui raised card"><div class="content"><div class="label">${s}</div><div class="meta">${t}</div><div class="description"><p contenteditable="true" data-placeholder="Введите описание">Описание</p><div class="ui inline labeled dropdown"><input type="hidden" value="0" data-property="type"><div class="text">${jQuery(d[0]).find(".item").data("text")}</div><i class="dropdown icon"></i><div class="menu">${d.join("")}</div></div></div></div><div class="ui bottom attached buttons"><button class="delete ui grey button">Удалить</button><div class="or" data-text="?"></div><button class="save ui positive button">Сохранить</button></div></div></div>`),p=c.find(".content>.label .label-text");c.find(".content>.label .dropdown").dropdown();let u=c.find('.content p[contenteditable="true"]'),m=c.find(".content>.description .dropdown").dropdown();return c.load=function(t){return c.object=t,p.text(t.label||""),u.text(t.title||""),m.dropdown("set exactly",""+(t.type||"0")),c.transition(c.is(":visible")?"jiggle":"fade right"),c},c.hide=function(){c.is(":visible")&&c.transition("fade right")},c.find(".save.button").click(function(){o(c.object,"label",p.text().trim()),o(c.object,"title",u.text()),c.object.type=m.dropdown("get value")[0],c.hide(),i(t,c.object)}),c.find(".delete.button").click(function(){c.hide(),n(t,c.object)}),c}function o(t, e, a){return a?t[e]=a:delete t[e],t}function c(t, e, a){return a&&(delete e.x,delete e.y,r.data[t].update(e)),e}function p(){r.graph.storePositions();let t,e,a=r.data[GraphEditor.ElementClasses.node.classID].get();a.length?(t=a.map(t=>t.x).reduce((t, e)=>t+e)/a.length,e=a.map(t=>t.y).reduce((t, e)=>t+e)/a.length):t=e=0,r.graph.moveTo({position:{x:t,y:e},scale:2,animation:!0})}function u(t){Object.getOwnPropertyNames(h).filter(e=>e!==t).forEach(t=>h[t].hide())}let m=Object.values(GraphEditor.ElementClasses).map(t=>Object.keys(r.types[t.classID]).map(e=>[t.classID,e])),h=Object.fromEntries([].concat(...m).map(t=>[t[0]+":"+t[1],d(t[0],t[1],function(t, e){r.graph.disableEditMode(),c(t,e,!0)},function(t, e){r.graph.disableEditMode(),r.data[t].remove(e.id)})])),E=function(t, e){let a,i,n=jQuery('<div class="pane"></div>'),s=0;return r.graph=new vis.Network(n[0],{nodes:r.data[GraphEditor.ElementClasses.node.classID],edges:r.data[GraphEditor.ElementClasses.edge.classID]},{manipulation:{enabled:!1,editEdge:function(t, a){t.from===t.to?a(null):(setTimeout(()=>{r.graph.disableEditMode()},1),s=0,a(e(GraphEditor.ElementClasses.edge.classID,t)))},addNode:function(t, a){t.type="0",delete t.label,setTimeout(()=>{r.graph.disableEditMode()},1),a(e(GraphEditor.ElementClasses.node.classID,t))},addEdge:function(t, a){t.type="0",delete t.label,delete t.title,setTimeout(()=>{r.graph.disableEditMode()},1),t.from!==t.to&&a(e(GraphEditor.ElementClasses.edge.classID,t))}},locale:"ru",physics:{stabilization:{fit:!1}},layout:{hierarchical:{direction:"LR",sortMethod:"directed",shakeTowards:"leaves"}}}),r.graph.addEventListener("select",function(n){n.nodes.length?(a=r.data[GraphEditor.ElementClasses.node.classID].get(n.nodes[0]),i=GraphEditor.ElementClasses.node.classID,t(i,a)):1===n.edges.length?(r.graph.editEdgeMode(),a=r.data[GraphEditor.ElementClasses.edge.classID].get(n.edges[0]),i=GraphEditor.ElementClasses.edge.classID,s=1,t(i,a)):a&&i&&e(i,a)}),n.find("canvas").click(function(){1===s?s=2:2===s&&(s=0,r.graph.disableEditMode(),r.graph.unselectAll())}),r.serialize=function(){return r.graph.storePositions(),JSON.stringify(Object.fromEntries(Object.entries(GraphEditor.ElementClasses).map(([t,e])=>[t,r.data[e.classID].get()])))},r.deserialize=function(t){let e=JSON.parse(t);Object.entries(GraphEditor.ElementClasses).forEach(([t,a])=>{r.data[a.classID].clear(),e[t].forEach(t=>r.data[a.classID].add(t))}),r.graph.stabilize(),p()},n}(function(t, e){u(t),h[t+":"+e.type].load(e)},function(t, e){return u(),c(t,e,!1)}),v=function(t){let e,a=jQuery('<div class="ui mini modal"><div class="header">Загрузить граф из файла</div><div class="content"><div class="file ui left labeled button"><a class="ui basic label">Файл не выбран</a><div class="ui icon button"><i class="file code icon"></i>Выбрать файл</div></div><input type="file" autocomplete="off" accept="application/json" hidden><div class="ui hidden negative message"><p>Невозможно загрузить файл. Проверьте правильность пути, формат или укажите другой файл.</p></div></div><div class="actions"><div class="ui negative cancel button">Отмена</div><div class="ui positive ok button">Загрузить</div></div></div>');function i(t){t||t!==l.is(":visible")||l.transition("fade up"),t?r.addClass("loading"):r.removeClass("loading")}let n=a.find('input[type="file"]'),s=a.find(".content .file.button .label"),l=a.find(".negative.message"),r=a.find(".actions .ok.button");return a.find(".content .file.button").click(()=>n.trigger("click")),n.change(function(){e=!(!this.files||!this.files[0])&&this.files[0],s.text(e&&e.name||"Выбрать файл")}),a.initialize=function(){a.modal({transition:"horizontal flip",blurring:!0,onApprove:function(){if(e){i(!0);let n=new FileReader;n.onerror=n.onabort=(()=>i(!1)),n.onload=function(e){try{t(e.target.result),r.removeClass("loading"),a.modal("hide")}catch(e){i(!1)}},n.readAsText(e)}else i(!1);return!1}})},a.show=(()=>a.modal("show")),a}(r.deserialize);r.load=(()=>v.show());let f=function(...t){let e=t.map(t=>jQuery(`<a class="item" data-name="${t.name}"><i class="${t.icon} icon"></i>${t.label}</a>`).click(t.click)),a=jQuery('<div class="graph-menu"><div class="ui compact labeled icon raised menu"></div></div>');return a.find(".menu").append(...e),a}({name:"addNode",label:"Новый узел",icon:"plus square",click:function(){u(),r.graph.addNodeMode()}},{name:"addEdge",label:"Новое ребро",icon:"long arrow alternate right",click:function(){u(),r.graph.addEdgeMode()}},{name:"fitZoom",label:"Выровнять",icon:"expand",click:p},{name:"save",label:"Сохранить",icon:"save",click:r.save},{name:"load",label:"Загрузить",icon:"folder open",click:r.load});return r.container.html(jQuery('<div class="graph-editor"></div>').append(E,v,f,...Object.values(h))),v.initialize(),p(),r}function GetArgumentNames(t){return t.toString().replace(/((\/\/.*$)|(\/\*[\s\S]*?\*\/)|(\s))/gm,"").match(/^function\s*[^\(]*\(\s*([^\)]*)\)/m)[1].split(/,/)}function ZipArrays(t, e){return t.map((t, a)=>[t,e[a]])}function CreateObjectFromArguments(t){return Object.fromEntries(ZipArrays(GetArgumentNames(t.callee),t))}GraphEditor.CreateElementClass=function(t, e){return CreateObjectFromArguments(arguments)},GraphEditor.CreateElementStyle=function(t, e, a){return CreateObjectFromArguments(arguments)},GraphEditor.CreateElementProperty=function(t, e, a, i){return CreateObjectFromArguments(arguments)},GraphEditor.CreateElementType=function(t, e, a, i, n, s, l){let r=l.filter(t=>t.elementClass!==e);if(r.length)throw`Can not create ${e} ${a} type with style(s) ${r.map(t=>t.styleID+"["+t.elementClass+"]").join(", ")}.`;let d=CreateObjectFromArguments(arguments);return d.visTemplate=Object.assign({},e.visTemplate,...l.map(t=>t.visTemplate)),d.propertiesValues=Object.fromEntries(s.map(t=>[t.propertyID,t.propertyDefaultValue])),d},GraphEditor.CreateElement=function(t, e, a={}, ...i){return{elementID:t,propertiesValues:Object.assign({},e.propertiesValues,a),visTemplate:Object.assign({},e.visTemplate,Object.fromEntries(ZipArrays(Object.keys(e.elementClass.visTemplate).slice(0,i.length),i))),elementType:e}},GraphEditor.ElementClasses=Object.freeze({Node:GraphEditor.CreateElementClass("Node",{x:0,y:0}),Edge:GraphEditor.CreateElementClass("Edge",{from:0,to:0})}),GraphEditor.PropertyClasses=Object.freeze({Text:"Текстовое поле"}),GraphEditor.CreateType_old=function(t, e, a, i, n, s){return{id:t,template:n,name:e,color:i,description:a,titles:s}},GraphEditor.CreateStyles_old=function(...t){let e={};for(let a in t)e[t[a].id]=t[a];return e},GraphEditor.GenerateID=function(){let t=[];for(let e=0; e<40; e++)t.push((16*Math.random()|0).toString(16));return t.join("")},GraphEditor.CreateNode=function(t, e){return Object.assign(e||{},{id:t||GraphEditor.GenerateID()})};
