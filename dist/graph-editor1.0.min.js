function GraphEditor(t,e,a=["Новый узел"],i,n,d){function s(t,e,a){let i;e=e||window;let n=t.split(".");a=a||n[0],n.forEach(t=>{if(void 0===(i=e[t]))throw`Graph editor error: ${a} library must be included.`;e=i})}s("jQuery"),s("vis.Network",!1,"Vis.js Network"),s("vis.DataSet",!1,"Vis.js DataSet"),s("transition",jQuery(),"Semantic UI"),s("modal",jQuery(),"Semantic UI"),s("dropdown",jQuery(),"Semantic UI");let o={classes:Object.freeze({node:"Узел",edge:"Ребро"}),container:jQuery(t).first(),save:()=>(function(t,e,a){let i=document.createElement("a"),n=new Blob([t],{type:a});i.href=URL.createObjectURL(n),i.download=e,i.click()})(o.serialize(),"graph.json","application/json"),addNode:(t,e=0,a,i={})=>{o.graph.storePositions();let n={x:0,y:0},d=o.data[o.classes.node].get();d.length&&(n.x=d.map(t=>t.x).reduce((t,e)=>t+e)/d.length,n.y=d.map(t=>t.y).reduce((t,e)=>t+e)/d.length,n.x+=100*Math.random()-50,n.y+=100*Math.random()-50);let s=$.extend(!0,o.types[o.classes.node][e].template,{id:t,type:e,label:a},n,i);return o.data[o.classes.node].add(s)[0]},addEdge:(t,e,a,i=0,n={})=>{let d=Object.assign({},o.types[o.classes.edge][i].template,{id:a,type:i,from:t,to:e},n);return o.data[o.classes.edge].add(d)[0]},removeNode:t=>o.data[o.classes.node].remove(t),removeEdge:t=>o.data[o.classes.edge].remove(t)};if(o.data={[o.classes.node]:new vis.DataSet(n),[o.classes.edge]:new vis.DataSet(d)},o.types={[o.classes.node]:e||GraphEditor.CreateStyles_old(GraphEditor.CreateType_old("0","Эллипс","Синие эллипсы","blue",{color:"#8dd0f8",shape:"ellipse"}),GraphEditor.CreateType_old("1","Прямоугольник","Зелёные прямоугольники","green",{color:"#82ec93",shape:"box"})),[o.classes.edge]:i||GraphEditor.CreateStyles_old(GraphEditor.CreateType_old("0","Сплошное","Без штриховки","hidden",{arrows:"to",dashes:!1,color:{inherit:"both"}}),GraphEditor.CreateType_old("1","Штрихованное","Равномерная штриховка","hidden",{arrows:"to",dashes:!0,color:{inherit:"both"}}))},!o.container.length)throw"Graph editor error: can not find container.";function l(t, e, i, n){let d,s=o.types[t],l=Object.keys(s).map(t=>`<div class="item" data-value="${t}" data-text='<div class="ui ${s[t].color} empty circular label"></div> ${s[t].name}'><div class="ui ${s[t].color} empty circular label"></div> ${s[t].name} <span class="description">${s[t].description}</span></div>`);if(t===o.classes.edge)d='<div class="label-text" contenteditable="true" data-placeholder="Введите название">Название</div>';else if(o.types[t][e].titles){d=`<div class="ui search selection dropdown"><input type="hidden" value="0" data-property="title"><i class="dropdown icon"></i><div class="label-text text">Название</div><div class="menu">${Object.keys(a).map(t=>`<div class="item" data-value="${t}" data-text='${a[t]}'>${a[t]}</span></div>`).join("")}</div></div>`}else d='<div class="label-text" contenteditable="true" data-placeholder="Введите название">Название</div>';let r=jQuery(`<div class="class-editor"><div class="ui raised card"><div class="content"><div class="label">${d}</div><div class="meta">${t}</div><div class="description"><p contenteditable="true" data-placeholder="Введите описание">Описание</p><div class="ui inline labeled dropdown"><input type="hidden" value="0" data-property="type"><div class="text">${jQuery(l[0]).find(".item").data("text")}</div><i class="dropdown icon"></i><div class="menu">${l.join("")}</div></div></div></div><div class="ui bottom attached buttons"><button class="delete ui grey button">Удалить</button><div class="or" data-text="?"></div><button class="save ui positive button">Сохранить</button></div></div></div>`),u=r.find(".content>.label .label-text");r.find(".content>.label .dropdown").dropdown();let p=r.find('.content p[contenteditable="true"]'),v=r.find(".content>.description .dropdown").dropdown();return r.load=function(t){return r.object=t,u.text(t.label||""),p.text(t.title||""),v.dropdown("set exactly",""+(t.type||"0")),r.transition(r.is(":visible")?"jiggle":"fade right"),r},r.hide=function(){r.is(":visible")&&r.transition("fade right")},r.find(".save.button").click(function(){c(r.object,"label",u.text().trim()),c(r.object,"title",p.text()),r.object.type=v.dropdown("get value")[0],r.hide(),i(t,r.object)}),r.find(".delete.button").click(function(){r.hide(),n(t,r.object)}),r}function c(t, e, a){return a?t[e]=a:delete t[e],t}function r(t, e, a){return a&&(delete e.x,delete e.y,o.data[t].update(e)),e}function u(){o.graph.storePositions();let t,e,a=o.data[o.classes.node].get();a.length?(t=a.map(t=>t.x).reduce((t, e)=>t+e)/a.length,e=a.map(t=>t.y).reduce((t, e)=>t+e)/a.length):t=e=0,o.graph.moveTo({position:{x:t,y:e},scale:2,animation:!0})}function p(t){Object.getOwnPropertyNames(h).filter(e=>e!==t).forEach(t=>h[t].hide())}let v=Object.values(o.classes).map(t=>Object.keys(o.types[t]).map(e=>[t,e])),h=Object.fromEntries([].concat(...v).map(t=>[t[0]+":"+t[1],l(t[0],t[1],function(t, e){o.graph.disableEditMode(),r(t,e,!0)},function(t, e){o.graph.disableEditMode(),o.data[t].remove(e.id)})])),f=function(t, e){let a,i,n=jQuery('<div class="pane"></div>'),d=0;return o.graph=new vis.Network(n[0],{nodes:o.data[o.classes.node],edges:o.data[o.classes.edge]},{manipulation:{enabled:!1,editEdge:function(t, a){t.from===t.to?a(null):(setTimeout(()=>{o.graph.disableEditMode()},1),d=0,a(e(o.classes.edge,t)))},addNode:function(t, a){t.type="0",delete t.label,setTimeout(()=>{o.graph.disableEditMode()},1),a(e(o.classes.node,t))},addEdge:function(t, a){t.type="0",delete t.label,delete t.title,setTimeout(()=>{o.graph.disableEditMode()},1),t.from!==t.to&&a(e(o.classes.edge,t))}},locale:"ru",physics:{stabilization:{fit:!1}},layout:{hierarchical:{direction:"LR",sortMethod:"directed",shakeTowards:"leaves"}}}),o.graph.addEventListener("select",function(n){n.nodes.length?(a=o.data[o.classes.node].get(n.nodes[0]),i=o.classes.node,t(i,a)):1===n.edges.length?(o.graph.editEdgeMode(),a=o.data[o.classes.edge].get(n.edges[0]),i=o.classes.edge,d=1,t(i,a)):a&&i&&e(i,a)}),n.find("canvas").click(function(){1===d?d=2:2===d&&(d=0,o.graph.disableEditMode(),o.graph.unselectAll())}),o.serialize=function(){return o.graph.storePositions(),JSON.stringify(Object.fromEntries(Object.entries(o.classes).map(([t,e])=>[t,o.data[e].get()])))},o.deserialize=function(t){let e=JSON.parse(t);Object.entries(o.classes).forEach(([t,a])=>{o.data[a].clear(),e[t].forEach(t=>o.data[a].add(t))}),o.graph.stabilize(),u()},n}(function(t, e){p(t),h[t+":"+e.type].load(e)},function(t, e){return p(),r(t,e,!1)}),b=function(t){let e,a=jQuery('<div class="ui mini modal"><div class="header">Загрузить граф из файла</div><div class="content"><div class="file ui left labeled button"><a class="ui basic label">Файл не выбран</a><div class="ui icon button"><i class="file code icon"></i>Выбрать файл</div></div><input type="file" autocomplete="off" accept="application/json" hidden><div class="ui hidden negative message"><p>Невозможно загрузить файл. Проверьте правильность пути, формат или укажите другой файл.</p></div></div><div class="actions"><div class="ui negative cancel button">Отмена</div><div class="ui positive ok button">Загрузить</div></div></div>');function i(t){t||t!==s.is(":visible")||s.transition("fade up"),t?o.addClass("loading"):o.removeClass("loading")}let n=a.find('input[type="file"]'),d=a.find(".content .file.button .label"),s=a.find(".negative.message"),o=a.find(".actions .ok.button");return a.find(".content .file.button").click(()=>n.trigger("click")),n.change(function(){e=!(!this.files||!this.files[0])&&this.files[0],d.text(e&&e.name||"Выбрать файл")}),a.initialize=function(){a.modal({transition:"horizontal flip",blurring:!0,onApprove:function(){if(e){i(!0);let n=new FileReader;n.onerror=n.onabort=(()=>i(!1)),n.onload=function(e){try{t(e.target.result),o.removeClass("loading"),a.modal("hide")}catch(e){i(!1)}},n.readAsText(e)}else i(!1);return!1}})},a.show=(()=>a.modal("show")),a}(o.deserialize);o.load=(()=>b.show());let g=function(...t){let e=t.map(t=>jQuery(`<a class="item" data-name="${t.name}"><i class="${t.icon} icon"></i>${t.label}</a>`).click(t.click)),a=jQuery('<div class="graph-menu"><div class="ui compact labeled icon raised menu"></div></div>');return a.find(".menu").append(...e),a}({name:"addNode",label:"Новый узел",icon:"plus square",click:function(){p(),o.graph.addNodeMode()}},{name:"addEdge",label:"Новое ребро",icon:"long arrow alternate right",click:function(){p(),o.graph.addEdgeMode()}},{name:"fitZoom",label:"Выровнять",icon:"expand",click:u},{name:"save",label:"Сохранить",icon:"save",click:o.save},{name:"load",label:"Загрузить",icon:"folder open",click:o.load});return o.container.html(jQuery('<div class="graph-editor"></div>').append(f,b,g,...Object.values(h))),b.initialize(),u(),o}GraphEditor.CreateType_old=function(t, e, a, i, n, d){return{id:t,template:n,name:e,color:i,description:a,titles:d}},GraphEditor.CreateStyles_old=function(...t){let e={};for(let a in t)e[t[a].id]=t[a];return e};
